% pdfcrop --bbox "0 1800 612 2592" calendar.pdf test-print.pdf

\documentclass{article}

\usepackage[paperwidth=60in, paperheight=36in, margin=1in,
% Use showframe to show the margin space
% showframe
]{geometry}
\usepackage{luacode}

\usepackage{scalefnt}
\usepackage{graphicx}

\setlength{\parindent}{0pt}

\begin{document}
\thispagestyle{empty}

\begin{luacode*}

function getWeekDates(year, week)
    -- Validate week number (1-53)
    if week < 1 or week > 53 then
        return nil, nil, "Invalid week number"
    end
    
    -- Get January 1st of the year
    local jan1 = os.time({year=year, month=1, day=1})
    
    -- Get the day of week (1-7, where 1 is Sunday)
    local jan1_wday = os.date("*t", jan1).wday
    
    -- Calculate days to first Monday of year
    local days_to_monday = 0
    if jan1_wday <= 4 then
        days_to_monday = -(jan1_wday - 2)  -- 2 is Monday
    else
        days_to_monday = (9 - jan1_wday)
    end
    
    -- Calculate start of requested week
    local week_start = jan1 + ((days_to_monday + (week - 1) * 7) * 24 * 60 * 60)
    local week_end = week_start + (6 * 24 * 60 * 60)
    
    -- Get detailed date info for start and end
    local start_date = os.date("*t", week_start)
    local end_date = os.date("*t", week_end)
    
    -- Month names
    local months = {
        "Jan", "Feb", "Mar", "Apr", "May", "Jun",
        "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
    }
    
    -- Format the output string
    local formatted_date
    if start_date.month == end_date.month then
        formatted_date = string.format("%s %d-%d",
            months[start_date.month],
            start_date.day,
            end_date.day)
    else
        formatted_date = string.format("%s %d-%s %d",
            months[start_date.month],
            start_date.day,
            months[end_date.month],
            end_date.day)
    end
    
    return formatted_date
end

function pt2in(pt)
  return pt/72.0
end

function print_crop_command(paper_width, paper_height, test_width, test_height)
  local crop_width = test_width * 72  -- convert to points
  local crop_height = test_height * 72  -- convert to points
  local total_height = paper_height * 72  -- total page height in points
  local crop_bottom = total_height - crop_height
  texio.write_nl(string.format('**********************************'))
  texio.write_nl(string.format('To print upper-left %.1fx%.1f test section, run:', test_width, test_height))
  texio.write_nl(string.format('pdfcrop --bbox "0 %d %d %d" calendar.pdf test-print.pdf',
    crop_bottom, crop_width, total_height))
  texio.write_nl(string.format('**********************************'))
end

-- Configuration (set these values)
cfg = {
  print_dates = true,      -- should dates be printed in every square?
  year_one_line = false,   -- should the year in the left column be on one line?
  year_count = false,      -- print year count after year?
  paper_width = 60,        -- in inches: keep in sync with the geometry command above
  paper_height = 36,       -- in inches: keep in sync with the geometry command above
  margin = 1,              -- in inches: keep in sync with the geometry command above
  start = 2026,            -- year of first row
  years = 30,              -- how many years
  -- Font sizes: \tiny \scriptsize \footnotesize \small \normalsize
  -- \large \Large \LARGE \huge \Huge
  week_num_size = [[\LARGE]],      -- week numbers across the top
  year_size = [[\LARGE]],          -- year numbers in left column
  date_size = [[\footnotesize]],   -- dates in each box
}

function draw_grid()
  local c = cfg -- shorthand

  local year_margin = 0.5
  if c.year_one_line then
    year_margin = 0.8
  end

  -- Calculate box width (this formula works well)
  -- The 10pt accounts for \fbox borders/padding plus inter-box spacing
  local box_width = (c.paper_width - 2*c.margin - year_margin)/52 - pt2in(10.0)
  local week_num_space = box_width + pt2in(6.8)

  -- Measure actual header height by running TeX locally and reading the box
  tex.runtoks(function()
    tex.sprint(string.format([[\setbox0=\hbox{%s Xg}]], c.week_num_size))
  end)
  local header_height_pt = tex.box[0].height / 65536
  local header_space = pt2in(header_height_pt + 4) -- measured height + vskip (2pt) + padding

  texio.write_nl(string.format('Measured header height: %.1fpt', header_height_pt))

  -- Calculate box_height so vertical gap equals horizontal gap
  -- Horizontally: adjacent \fbox boxes touch, so visible gap = 2 * fboxrule = 0.8pt
  -- Vertically: we need to add explicit vskip to create the same gap
  -- The fbox adds fbox_overhead to each box's rendered size
  local num_rows = c.years + 1
  local fbox_overhead = pt2in(6.8) -- 2*(fboxrule + fboxsep) = 2*(0.4pt + 3pt)
  local visible_gap = pt2in(3.2) -- small gap to match horizontal inter-box spacing
  local available = c.paper_height - 2*c.margin - header_space
  -- Total = num_rows * (box_height + fbox_overhead) + (num_rows - 1) * visible_gap
  local box_height = (available - num_rows * fbox_overhead - (num_rows - 1) * visible_gap) / num_rows

  texio.write_nl(string.format('**********************************WIDTH: %.3f - HEIGHT: %.3f', box_width, box_height))

  -- Print week numbers across the top
  local week_num_start = year_margin + box_width/10
  tex.print(string.format([[\noindent\kern%.5fin]], week_num_start))
  for week = 1, 52 do
    tex.print(string.format([[{\hbox to %.5fin{\hfil %s %d\hfil}}]], week_num_space, c.week_num_size, week))
  end
  tex.print([[\par\vskip2pt\noindent]])

  -- Main grid
  for year = 0, c.years do
    -- Center year vertically relative to box height
    if c.year_count then
      if c.year_one_line then
        tex.print(string.format([[{\vbox to %.5fin{\vfil\hbox to %.5fin{\hfil%s %d: %d\hfil}\vfil}}]],
          box_height, year_margin, c.year_size, c.start + year, year))
      else
        tex.print(string.format([[{\vbox to %.5fin{\vfil\vbox{%s \hbox to %.5fin{\hfil %d\hfil}\hbox to %.5fin{\hfil %d\hfil}}\vfil}}]],
          box_height, c.year_size, year_margin, c.start + year, year_margin, year))
      end
    else
      tex.print(string.format([[{\vbox to %.5fin{\vfil\hbox to %.5fin{\hfil%s %d\hfil}\vfil}}]],
        box_height, year_margin, c.year_size, c.start + year))
    end

    for week = 1, 52 do
      local date_string = ""
      if c.print_dates then
        date_string = string.format([[\rlap{\smash{%s %s}}]], c.date_size, getWeekDates(c.start + year, week))
      end
      tex.print(string.format([[\fbox{%s\vbox to %.5fin{\vfil\hbox to %.5fin{\hfil}\vfil}}]],
           date_string, box_height, box_width))
    end

    -- Space between each row (equal to visible_gap to match horizontal spacing)
    if year < c.years then
      tex.print(string.format([[\par\nointerlineskip\vskip%.5fin\noindent]], visible_gap))
    end
  end

  -- Print the pdfcrop command for test printing
  print_crop_command(c.paper_width, c.paper_height, 8.5, 11)
end
\end{luacode*}

\directlua{draw_grid()}

\end{document}